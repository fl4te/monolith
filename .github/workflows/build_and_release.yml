name: Build & Release Monolith

permissions:
  contents: write

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build & Package (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka zstandard
          pip install -r requirements.txt

      # ------------------------
      # Build (Windows)
      # ------------------------
      - name: Build executable (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: >
          python -m nuitka
          --standalone
          --onefile
          --disable-console
          --enable-plugin=tk-inter
          --assume-yes-for-downloads
          --include-module=pil_config
          --include-module=PIL.Image
          --include-module=PIL.ImageTk
          --include-module=PIL._tkinter_finder
          --include-module=PIL.JpegImagePlugin
          --include-module=PIL.PngImagePlugin
          --include-module=PIL.TgaImagePlugin
          --nofollow-import-to=PIL.BmpImagePlugin
          --nofollow-import-to=PIL.GifImagePlugin
          --nofollow-import-to=PIL.TiffImagePlugin
          --nofollow-import-to=PIL.WebPImagePlugin
          --nofollow-import-to=PIL.PdfImagePlugin
          --nofollow-import-to=PIL.PcxImagePlugin
          --nofollow-import-to=PIL.IcoImagePlugin
          --nofollow-import-to=PIL.XpmImagePlugin
          --nofollow-import-to=PIL.FtexImagePlugin
          --windows-icon-from-ico=icon.ico
          --lto=yes
          --include-package-data=CTkMessagebox
          --include-package-data=customtkinter
          monolith.py

      # ------------------------
      # Build (Linux & macOS)
      # ------------------------
      - name: Build executable (Linux & macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          python -m nuitka \
            --standalone \
            --onefile \
            --enable-plugin=tk-inter \
            --assume-yes-for-downloads \
            --include-module=pil_config \
            --include-module=PIL.Image \
            --include-module=PIL.ImageTk \
            --include-module=PIL._tkinter_finder \
            --include-module=PIL.JpegImagePlugin \
            --include-module=PIL.PngImagePlugin \
            --include-module=PIL.TgaImagePlugin \
            --nofollow-import-to=PIL.BmpImagePlugin \
            --nofollow-import-to=PIL.GifImagePlugin \
            --nofollow-import-to=PIL.TiffImagePlugin \
            --nofollow-import-to=PIL.WebPImagePlugin \
            --nofollow-import-to=PIL.PdfImagePlugin \
            --nofollow-import-to=PIL.PcxImagePlugin \
            --nofollow-import-to=PIL.IcoImagePlugin \
            --nofollow-import-to=PIL.XpmImagePlugin \
            --nofollow-import-to=PIL.FtexImagePlugin \
            --include-package-data=CTkMessagebox \
            --include-package-data=customtkinter \
            monolith.py

      # ------------------------
      # Packaging
      # ------------------------
      - name: Package Windows ZIP
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          mkdir packaged -Force
          Compress-Archive monolith.exe packaged/Monolith-windows.zip -Force

      - name: Package Linux tar.gz
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          mkdir -p packaged
          tar -czvf packaged/Monolith-linux.tar.gz monolith.bin

      - name: Package macOS DMG
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          mkdir -p dmg/Monolith.app/Contents/MacOS
          cp monolith.bin dmg/Monolith.app/Contents/MacOS/Monolith
          chmod +x dmg/Monolith.app/Contents/MacOS/Monolith
          mkdir -p packaged
          hdiutil create -volname "Monolith" -srcfolder dmg -ov -format UDZO packaged/Monolith-macos.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Monolith-${{ matrix.os }}
          path: packaged/*

  release:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Create release
        run: |
          mkdir release
          find all-artifacts -type f -exec cp {} release/ \;
          TAG="v$(date +'%Y.%m.%d')-${GITHUB_SHA:0:7}"
          gh release create "$TAG" release/* --title "Release $TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
